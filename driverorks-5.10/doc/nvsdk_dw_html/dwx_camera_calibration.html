<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!--
 * Copyright (c) 2009-2014 NVIDIA CORPORATION.  All rights reserved.
 *
 * NVIDIA Corporation and its licensors retain all intellectual property
 * and proprietary rights in and to this software, related documentation
 * and any modifications thereto.  Any use, reproduction, disclosure or
 * distribution of this software and related documentation without an express
 * license agreement from NVIDIA Corporation is strictly prohibited.
-->
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<title>DriveWorks SDK Reference: Static Camera Calibration Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="Nvidia.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="reverb-search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="nv.css" rel="stylesheet" type="text/css" />
<link href="nvdwx.css" rel="stylesheet" type="text/css"/>
<style>
 body {
 background-position: 350px 150px;
 background-image: url(watermark.png);
 background-repeat: no-repeat;
 background-attachment: fixed;
 }
 </style>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table width="99%" border="0" cellspacing="1" cellpadding="1">
  <tbody>
    <tr valign="middle">
      <td rowspan="2" height="44" width="19%">
        <div>
            <a id="nv-logo" href="https://www.nvidia.com/"></a>
        </div>
      <td width="81%" height="44">
        <div style="text-align:right; font-weight: bold; font-size:20px"> <br/>DriveWorks SDK Reference </div>
        <div style="text-align:right">
        5.10.87 Release <br/> For Test and Development only <br/> <br/> </div>
    </td>
  </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dwx_camera_calibration.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Static Camera Calibration Tutorial </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#dwx_camera_calibration_prereq">1 Prerequisites</a><ul><li class="level2"><a href="#dwx_camera_calibration_prereq_cams">1.1 Cameras</a><ul><li class="level3"><a href="#dwx_camera_calibration_prereq_avcams">1.1.1 AV Cameras</a></li>
<li class="level3"><a href="#dwx_camera_calibration_prereq_externalcam">1.1.2 External Camera</a></li>
</ul>
</li>
<li class="level2"><a href="#dwx_camera_calibration_prereq_targets">1.2 Targets</a><ul><li class="level3"><a href="#dwx_camera_calibration_prereq_targets_prints">1.2.1 AprilTag Targets</a></li>
<li class="level3"><a href="#dwx_camera_calibration_prereq_targets_checkerboard">1.2.2 Checkerboard Target</a></li>
<li class="level3"><a href="#dwx_camera_calibration_prereq_targets_print_val">1.2.3 Target Print Validation</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#dwx_camera_calibration_setup">2 Scene Setup</a><ul><li class="level2"><a href="#dwx_camera_calibration_setup_cams">2.1 Camera Placement</a></li>
<li class="level2"><a href="#dwx_camera_calibration_setup_targets">2.2 Target Placement</a></li>
</ul>
</li>
<li class="level1"><a href="#dwx_camera_calibration_data">3 Capturing Data</a><ul><li class="level2"><a href="#dwx_camera_calibration_data_int">3.1 Capturing Data for Intrinsic Camera Calibration</a><ul><li class="level3"><a href="#dwx_camera_calibration_data_int_recording">3.1.1 Recording Options</a></li>
<li class="level3"><a href="#dwx_camera_calibration_data_int_external">3.1.2 External Camera Intrinsics</a></li>
</ul>
</li>
<li class="level2"><a href="#dwx_camera_calibration_data_ext">3.2 Capturing Data for Extrinsic Camera Calibration</a><ul><li class="level3"><a href="#dwx_camera_calibration_extrinsics_images">3.2.1 Extrinsics Images</a></li>
<li class="level3"><a href="#dwx_camera_calibration_external_images">3.2.2 External Images</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#dwx_camera_calibration_tooling">4 Using the Calibration Tools</a><ul><li class="level2"><a href="#dwx_camera_calibration_tools_dir">4.1 Directory Structure</a><ul><li class="level3"><a href="#dwx_camera_calibration_targetsjson">4.1.1 targets.json</a></li>
<li class="level3"><a href="#dwx_coordinate_systems_specialtargets">4.1.2 special-targets.json</a></li>
<li class="level3"><a href="#dwx_camera_calibration_extraconstraints">4.1.3 (Optional) extra-constraints.json</a></li>
</ul>
</li>
<li class="level2"><a href="#dwx_camera_calibration_tools_int">4.2 Camera Intrinsics</a></li>
<li class="level2"><a href="#dwx_camera_calibration_tools_ext">4.3 Camera Calibration</a><ul><li class="level3"><a href="#dwx_camera_calibration_tools_ext_setup">4.3.1 Extrinsic Calibration Setup</a></li>
<li class="level3"><a href="#dwx_camera_calibration_tools_ext_exec">4.3.2 Extrinsic Calibration Execution</a></li>
<li class="level3"><a href="#dwx_camera_calibration_tools_ext_val">4.3.3 Extrinsic Calibration Validation</a></li>
</ul>
</li>
<li class="level2"><a href="#dwx_camera_calibration_tools_rig">4.4 Generating DriveWorks &lt;tt&gt;rig.json&lt;/tt&gt; File</a></li>
</ul>
</li>
<li class="level1"><a href="#dwx_camera_calibration_additional_info">5 Additional Information</a><ul><li class="level2"><a href="#dwx_camera_calibration_int_only">5.1 Intrinsic-only Calibration</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p >The NVIDIA<sup>&reg;</sup> Static Camera Calibration tutorial describes how to perform intrinsic and extrinsic calibration for a vehicle's cameras using the <a class="el" href="dwx_camera_calibration_tools.html">Camera Calibration Tools</a>.</p>
<p >This step-by-step tutorial covers the following aspects:</p><ul>
<li><a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq">1 Prerequisites</a> : The materials required to perform calibration.</li>
<li><a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_setup">2 Scene Setup</a> : The proper camera and target placements.</li>
<li><a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data">3 Capturing Data</a> : Capturing the intrinsic and extrinsic data required by the tools.</li>
<li><a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tooling">4 Using the Calibration Tools</a> : Generating camera calibration output.</li>
<li><a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_additional_info">5 Additional Information</a> : Additional Information including intrinsic-only calibration.</li>
</ul>
<h1><a class="anchor" id="dwx_camera_calibration_prereq"></a>
1 Prerequisites</h1>
<p >The following cameras and targets are required before proceeding in this tutorial.</p>
<h2><a class="anchor" id="dwx_camera_calibration_prereq_cams"></a>
1.1 Cameras</h2>
<p >The following cameras are required for calibration:</p>
<h3><a class="anchor" id="dwx_camera_calibration_prereq_avcams"></a>
1.1.1 AV Cameras</h3>
<p >These comprise the set of cameras to be calibrated, referred to as "camera" or "cameras" in this tutorial: </p><h3>Requirements:</h3>
<ul>
<li>Fixed focal length cameras. In this tutorial, 12 AR0231 cameras are used as an example.</li>
<li>Cameras are expected to be rigidly mounted on the vehicle and should not be moved relative to the vehicle after completion of this tutorial. <dl class="section note"><dt>Note</dt><dd>Intrinsic calibration can also be performed before mounting of the cameras, if there is no additional distortion after mounting (e.g. caused by camera housing glass or windshield).</dd></dl>
</li>
</ul>
<h3><a class="anchor" id="dwx_camera_calibration_prereq_externalcam"></a>
1.1.2 External Camera</h3>
<p >An external photo camera is required to support the calibration of the AV Cameras, referred to as "external camera" in this tutorial: </p><h3>Requirements:</h3>
<ul>
<li>Fixed focal length of roughly 18mm-30mm.</li>
<li>At least 12MP resolution.</li>
<li>Sensor size to be roughly Canon's ASP-C or Nikon's DX size (roughly 23mmx15mm).</li>
</ul>
<h2><a class="anchor" id="dwx_camera_calibration_prereq_targets"></a>
1.2 Targets</h2>
<p >This tutorial requires the use of targets to calibrate the vehicle's cameras.<br  />
</p>
<h3><a class="anchor" id="dwx_camera_calibration_prereq_targets_prints"></a>
1.2.1 AprilTag Targets</h3>
<p >The AprilTag targets used in this tutorial can be found in the following folder: </p><pre class="fragment">data/tools/calibration/aprilTargets
</pre><p> At 100% scaling factor, these target files (incl. boundary!) are of size DIN A4, but they are in vector format and can be scaled in a lossless fashion to A3, A2, A1, or A0.</p>
<p >An example of an AprilTag target used in this tutorial:</p>
<div class="image">
<img src="patterns.png" alt=""/>
<div class="caption">
Calibration Targets</div></div>
    <p >The targets must be printed as follows:</p>
<h3>12+ Large AprilTag Targets</h3>
<ul>
<li>Printed to A0 format (set print scaling to 400%)</li>
<li>Use the targets with <b>IDs 80-119</b> in <code>data/tools/calibration/aprilTargets</code></li>
<li>All printed boards must have different IDs.</li>
</ul>
<h3>4 Small AprilTag Targets</h3>
<ul>
<li>Printed to A3 format (set print scaling to sqrt(2), i.e. ca. 141.421%).</li>
<li>For standardization purposes, preferably use targets <b>IDs 180-183</b> in <code>data/tools/calibration/aprilTargets</code>.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>An AprilTag target with the same ID cannot be reused multiple times. </dd>
<dd>
Do not use targets printed from a different database than the one specified above.</dd></dl>
<h3><a class="anchor" id="dwx_camera_calibration_prereq_targets_checkerboard"></a>
1.2.2 Checkerboard Target</h3>
<p >Additionally, a checkerboard target is needed for intrinsics calibration. Two checkerboard target versions can be found under <code>data/tools/calibration/checkerboardTargets</code>, one for A0 and one for ANSI E paper format:</p><ul>
<li>checkerboard_12x9_3inches_ANSI_E.pdf</li>
<li>checkerboard_14x9_74mm_A0.pdf</li>
</ul>
<p >Any checkerboard pattern with the following properties is supported:</p><ul>
<li>It is asymmetric, meaning there is an even number of squares in one direction and an uneven number in the other direction.</li>
<li>It fills the paper format well, that is there is a roughly evenly sized white border around the pattern.</li>
<li>The white border around the pattern is one square size large or larger.</li>
<li>The squares are sufficiently large to be well distinguished by any camera captures.</li>
<li>There are many squares to produce a large amount of constraint points at the square corners.</li>
</ul>
<h3><a class="anchor" id="dwx_camera_calibration_prereq_targets_print_val"></a>
1.2.3 Target Print Validation</h3>
<p >For each AprilTag target, the length of the horizontal bar in millimeters (mm) must be measured and noted down in the specified location in the top left corner, as demonstrated in the <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_targets">above image</a>.</p>
<dl class="section note"><dt>Note</dt><dd>Ensure the printouts have correct aspect ratios by comparing the length of the vertical and horizontal bars. </dd>
<dd>
For checkerboard targets, measure the horizontal and vertical sizes of multiple squares. All measurements must be absolutely identical (sub-millimeter accuracy). </dd>
<dd>
<b>If their lengths are not equal, the targets MUST be reprinted, as they do not have the correct aspect ratio.</b> </dd>
<dd>
All targets must be perfectly flat, rigid, and must not bend. </dd>
<dd>
The target surface should have a matte surface to avoid glare and reflections.</dd></dl>
<p><br  />
</p>
<h1><a class="anchor" id="dwx_camera_calibration_setup"></a>
2 Scene Setup</h1>
<h2><a class="anchor" id="dwx_camera_calibration_setup_cams"></a>
2.1 Camera Placement</h2>
<p >Depending on the number and location of the cameras on the vehicle, different scene setups may be used.<br  />
 In this tutorial, a setup with 12 cameras mounted on a car roof is used as an example.</p>
<h2><a class="anchor" id="dwx_camera_calibration_setup_targets"></a>
2.2 Target Placement</h2>
<p >The following constraints and best-practices should be respected when placing targets during scene setup. Most of these constraints can be verified online with the <a class="el" href="dwx_calibration_recorder.html">Static Calibration Recorder Tool</a> tool in <code>extrinsics</code> mode:</p>
<ul>
<li>The 4 <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_targets_prints">small AprilTag targets</a> are placed on the wheels. The AprilTag target centers and wheel centers must be aligned. These AprilTag targets define the origin (center of rear axle on the floor) and orientation (x-y-z corresponds to forward-left-up relative to the car) of the results' <a class="el" href="dwx_coordinate_systems.html#coord_vehicle">coordinate system</a>. These targets must be listed in the <a class="el" href="dwx_camera_calibration.html#dwx_coordinate_systems_specialtargets">special-targets.json</a>. It is advisable to use a mechanical bracket to ensure precise mounting: <br  />
<br  />
<img src="wheel_target_bracket.jpg" alt="" class="inline"/> <br  />
</li>
<li>Each <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_cams">camera</a> should observe <b>two</b> or more <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_targets_prints">large targets</a>. The targets observed by a single camera should be angled with respect to each other, and viewed at different depths. Targets need to be fully observed by the camera sensors, partial coverage into the individual camera views is not sufficient.</li>
<li>All targets should be <b>as close as possible</b> to the cameras while still being <b>in focus</b> depending on the camera properties. For instances, tele-camera lenses usually have a focus region &gt; <code>6m</code> and targets need to be placed with this minimal distance, while the focus region of other camera types usuall allows or demands targets to be placed closer to the sensor.</li>
<li>A target should cover a large area of the image (more than a quarter, the more the better). This is particularly important for narrow field of view cameras, like e.g. a 30 degree tele camera.</li>
<li>Both observerability and focus proprties should be verified online with the <a class="el" href="dwx_calibration_recorder.html">Static Calibration Recorder Tool</a> tool in <code>extrinsics</code> mode, which has to visualize stable detections of all observed targets.</li>
<li>If it is not possible for the target to be both in focus and cover a large part of the image, use a bigger target, or add more AprilTag targets to the view.</li>
<li>Each AprilTag target in the scene must be <b>unique</b>, i.e. all targets must have different IDs.</li>
<li>Place some AprilTag targets on the floor next to the car. Those targets define the ground plane. All ground targets must be listed in the <a class="el" href="dwx_camera_calibration.html#dwx_coordinate_systems_specialtargets">special-targets.json</a>. <br  />
<br  />
<img src="calibration_ground_target.jpg" alt="" class="inline"/> <br  />
</li>
<li>Place some targets on the floor in front of fisheye cameras, in order to both define the ground plane and constrain the fisheye cameras. <br  />
<br  />
<img src="calibration_extrinsics_fisheye.jpg" alt="" class="inline"/> <br  />
</li>
<li>Ensure that the <b>floor is flat and level</b>, such that all ground targets lie on a single plane.</li>
</ul>
<p >Here is an illustration of how to place the AprilTag targets around a car with given sensor set:</p>
<div class="image">
<img src="hyperion8_l3_extrinsic_calibration_setup.png" alt=""/>
<div class="caption">
AprilTag Target Placement Illustration</div></div>
    <p >Note that two targets are used for both front/rear tele cameras at different depth and further away compared to the other targets for non-tele cameras to fullfill the target plamement requirements.</p>
<p >In this tutorial, a set of 8 large and 4 small AprilTag targets are used as an example.</p>
<p ><img src="targets_placement.png" alt="" class="inline" title="Reference Target Placement"/>     <br  />
 <img src="targets_placement2.png" alt="" class="inline" title="Example Target Placement"/>    </p>
<h1><a class="anchor" id="dwx_camera_calibration_data"></a>
3 Capturing Data</h1>
<p >The following types of data must be captured for static camera calibration:</p><ul>
<li><b>Intrinsic Data</b>: This only needs to be captured once if camera parameters i.e., lens, have not changed.</li>
<li><b>Extrinsic Data</b>: Includes images captured from the vehicle's cameras to be calibrated and images captured with the external camera.</li>
</ul>
<h2><a class="anchor" id="dwx_camera_calibration_data_int"></a>
3.1 Capturing Data for Intrinsic Camera Calibration</h2>
<p >In order to capture data for intrinsic camera calibration, a checkerboard target has be be moved in front of each camera to be calibrated.<br  />
<br  />
 <img src="intrinsic_calibration.jpg" alt="" class="inline"/> <br  />
<br  />
</p>
<p >Perform the following for one camera at a time:<br  />
<br  />
</p><ul>
<li><b>Move</b> the checkerboard target <b>from one side</b> of the camera's field of view <b>to the other</b>, both horizontally and vertically.</li>
<li>The accumulated checkerboard poses should fill the <b>entire camera's field of view uniformly</b>. The density of checkerboard detections should be roughly the same in all areas of the field of view.</li>
<li>There should be at least 30 calibration images per camera, the more the better.</li>
<li>At every position, <b>tilt the checkerboard target</b> both horizontally and vertically up to 45 degrees, and ensure that detections are being processed.</li>
<li>Do this at <b>various distances</b> from the camera. Distances should range from where that the target <b>covers about half of the image, down to 1/8th</b>, but no further than that.</li>
<li>Mount the target on a tripod to keep it <b>steady at each pose</b>. This allows precise constraint detection from motion-blur free images.</li>
<li>Ensure that the camera lens is clean and there are no cables or other items blocking the view of the checkerboard target.</li>
<li>Ensure that there is at most one calibration target present in view.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>It is often the case that part of a car-mounted camera's field of view is covered by part of the car, in particular for fisheye or wide angle lenses. Therefore it is advisable to perform intrinsics calibration before mounting the camera, otherwise it is difficult or impossible to get the uniform constraint-coverage of the field of view. However, it is also necessary to include all influences to the camera's intrinsics, such as distortion caused by camera-housings or the windshield.</dd></dl>
<h3><a class="anchor" id="dwx_camera_calibration_data_int_recording"></a>
3.1.1 Recording Options</h3>
<p >There are different options to capture the data for intrinsic camera calibration:</p>
<ul>
<li>Take still images of the checkerboard target in the various calibration poses.</li>
<li>Take a video recording of the checkerboard target in the various calibration poses.</li>
<li>Real-Time extraction of intrinsics constraints using the <a class="el" href="dwx_calibration_recorder.html">Static Calibration Recorder Tool</a> tool.</li>
</ul>
<p >Still images can be captured using <a class="el" href="dwx_camera_sample.html">Camera Sample</a>. Also see <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_extrinsics_images">3.2.1 Extrinsics Images</a>, where it is also necessary to get still images from video or camera.</p>
<p >For the video option, refer to <a class="el" href="dwx_recording_devguide_basic_recording.html">Basic Recording</a> for more information how to use the camera recorder. </p><dl class="section note"><dt>Note</dt><dd>To save disk space setup the recorder to record h264/mp4 stream directly, e.g. by passing <code>format=h264,output-format=yuv</code> as camera sensor properties. <br  />
<br  />
</dd></dl>
<p>The <a class="el" href="dwx_intrinsics_constraints.html">Intrinsics Constraints Tool</a> will automatically extract all valid frames from such a recorded video (see <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_int">4.2 Camera Intrinsics</a>).</p>
<p >The <a class="el" href="dwx_calibration_recorder.html">Static Calibration Recorder Tool</a> tool allows to skip the recording step, as it directly extracts the required intrinsics constraints data from the live video stream of the camera.</p>
<h3><a class="anchor" id="dwx_camera_calibration_data_int_external"></a>
3.1.2 External Camera Intrinsics</h3>
<p >To calibrate the intrinsics of the supplied external camera, a set of checkerboard images should be captured, following the same process as described above (<a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data_int">3.1 Capturing Data for Intrinsic Camera Calibration</a>). It is also possible to move the camera instead of the checkerbard target, which may be more convenient when using the external camera.</p>
<h2><a class="anchor" id="dwx_camera_calibration_data_ext"></a>
3.2 Capturing Data for Extrinsic Camera Calibration</h2>
<h3><a class="anchor" id="dwx_camera_calibration_extrinsics_images"></a>
3.2.1 Extrinsics Images</h3>
<p >Use one of the following methods to capture one image from each car camera. These images should then be named and placed in the appropriate location according to <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_dir">4.1 Directory Structure</a>.</p>
<h3>Using the Calibration Recorder Tool</h3>
<dl class="section note"><dt>Note</dt><dd>This is the recommended option.</dd></dl>
<p>Run the <a class="el" href="dwx_calibration_recorder.html">Static Calibration Recorder Tool</a> tool with the rig file containing the cameras to be calibrated, select the "Extrinsics" mode, set up the scene with the AprilTag targets as described in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_setup">2 Scene Setup</a> and save the scene images to files.</p>
<h3>Using the DriveWorks Sample</h3>
<p >Run the <a class="el" href="dwx_camera_sample.html">Camera Sample</a> to capture a frame.</p>
<ol type="1">
<li>Pass a rig .json file containing the camera sensors to the sample: <pre class="fragment"> ./sample_camera --rig=&lt;path/to/rig&gt;
</pre> <br  />
</li>
<li>Press <b>F</b> while the sample is running to capture a frame from each camera as a .png file.</li>
</ol>
<h3>Using the DriveWorks Recorder</h3>
<dl class="section note"><dt>Note</dt><dd>This option is deprecated and not recommended.</dd></dl>
<p>Run the DriveWorks <a class="el" href="dwx_recording_tools.html">Recording Tools</a> to simultaneously record video from all cameras. Use ffmpeg to extract one frame from the video.</p>
<ol type="1">
<li>Setup the Driveworks Recorder Tool as described in <a class="el" href="dwx_recording_devguide_basic_recording.html">Basic Recording</a> (use h264/mp4 recording)<br  />
<br  />
</li>
<li>Extract individual frames with ffmpeg: <pre class="fragment"> ffmpeg -i \&lt;folder\&gt;/camera_X.h264 -t 1 -f image2 camera_X.png
</pre> </li>
</ol>
<h3><a class="anchor" id="dwx_camera_calibration_external_images"></a>
3.2.2 External Images</h3>
<p >In addition to capturing frames from the vehicle's cameras, a set of images from an outside view is required.<br  />
 These external images help constructing a calibration graph as they introduce a link between AprilTag targets not observable by the car cameras.<br  />
 All AprilTag targets need to be linked, including ground targets, wheel targets, and the targets observed by the individual cameras. Links are established between AprilTag targets that are visible in a single image.</p>
<p >Consider the following for external images:</p><ul>
<li>Capture at least <em>40</em> images with the external camera. The more, the better.</li>
<li>Try to have as many boards in a single view of an external image as possible &ndash; also across large distances. The minimum is two, but ideally one should aim at <em>more than three</em>. Ideally, all possible AprilTag target pairs are captured.</li>
<li>Ensure these images simultaneously observe both the ground targets, and the wheel targets.</li>
<li>Make sure all images images are sharp and well lit.<ul>
<li>Use <b>fixed manual focus</b>. Don't change it during the process. This ensures consistent intrinsic parameters for the external camera images.</li>
<li>Use a tripod.</li>
<li>Use short shutter-speed to reduce motion blur.</li>
<li>Use fixed small aperture (large f/number) for a large depth of field.</li>
<li>This requires to have a lot of light in the scene for good contrast images.</li>
<li>There should be no glare on the targets, so there should be strong diffuse lighting of the scene.</li>
</ul>
</li>
</ul>
<p >The following demonstrates the types of images to capture with the external camera:</p>
<div class="image">
<img src="external_camera.png" alt=""/>
<div class="caption">
Images to Capture with the External Camera</div></div>
    <h1><a class="anchor" id="dwx_camera_calibration_tooling"></a>
4 Using the Calibration Tools</h1>
<p >The Static Calibration Tool suite consists of multiple command line tools. This tutorial covers the tools required for static calibration of the vehicle's cameras. The core tool for camera calibration is the <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a>. There are additional calibration tools for auxiliary support and additional sensors. These are not covered in this tutorial. All tools used in this section are documented in <a class="el" href="dwx_camera_calibration_tools.html">Camera Calibration Tools</a>.</p>
<dl class="section note"><dt>Note</dt><dd>It is recommended to run the calibration tool suite on an x86 Host System due to the resource requirements of the internal optimization.</dd></dl>
<h2><a class="anchor" id="dwx_camera_calibration_tools_dir"></a>
4.1 Directory Structure</h2>
<p >The calibration data from <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data">3 Capturing Data</a> is passed to the <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a> through a specific directory structure with a predefined collection of files, see <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_expectedfs">Directory</a>.<br  />
</p>
<p >Place</p><ul>
<li>one intrinsics json file per camera into the <b>intrinsics</b> directory</li>
<li>one image per <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_avcams">AV camera</a> into the <b>extrinsics</b> directory</li>
<li>all images from the <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_externalcam">external camera</a> into the <b>external</b> directory</li>
</ul>
<h3><a class="anchor" id="dwx_camera_calibration_targetsjson"></a>
4.1.1 targets.json</h3>
<p >Modify the <code>targets.json</code> file and change the <code>barLength</code> fields for all AprilTag targets in the scene to the length (in meters) measured in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_prereq_targets_print_val">1.2.3 Target Print Validation</a>. Also see <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_targetdb">Target Database <code>targets.json</code></a>.</p>
<h3><a class="anchor" id="dwx_coordinate_systems_specialtargets"></a>
4.1.2 special-targets.json</h3>
<p ><b>special-targets.json</b>: The AprilTag targets attached to the wheels and the AprilTag targets that lie flat on the floor must also be declared in this file. See <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_special">Special Targets</a> for the exact file structure.</p>
<p >Ensure that the targets on the ground and the onces attached to the wheels are correctly identified in this file.</p>
<h3><a class="anchor" id="dwx_camera_calibration_extraconstraints"></a>
4.1.3 (Optional) extra-constraints.json</h3>
<p ><b>extra-constraints.json</b>: Additional <em>prior knowledge</em> (e.g., from CAD data) can be provided to the estimation with this file, which can be beneficial to improve the quality of the estimation. See <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_extra">Extra Constraints</a> for the exact file structure and <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_extra_constraint_types">Extra Constraint Types</a> for a list of currently supported constraints.</p>
<p >Ensure carefully that all provided prior values in this file are <em>accurate</em> (up to their respective expected variances), as inaccurate prior's can only be corrected to a limited extend by the estimation and will likely result in calibration failures.</p>
<h2><a class="anchor" id="dwx_camera_calibration_tools_int"></a>
4.2 Camera Intrinsics</h2>
<p >With the exception of the external camera, this section can be skipped if the <a class="el" href="dwx_calibration_recorder.html">Static Calibration Recorder Tool</a> tool has been used in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data_int_recording">3.1.1 Recording Options</a>, as that directly outputs the .json files with intrinsics constraints.</p>
<p >Otherwise, if a calibration video or images have been captured in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data_int_recording">3.1.1 Recording Options</a>, the usage of the DriveWorks <a class="el" href="dwx_intrinsics_constraints.html">Intrinsics Constraints Tool</a> is required to extract the intrinsics constraints for each individual camera.<br  />
 The tool exports all required constraints into a <code>.json</code> file to to be placed into the <code>/intrinsics/</code> subfolder in the directory structure. The actual calibration of the cameras' intrinsics happens later when running the <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a>.</p>
<p >See these usage <a class="el" href="dwx_intrinsics_constraints.html#dwx_intrinsics_constraints_examples">Examples</a> on how to extract the intrinsics constraints from the calibration videos or images.</p>
<p >The tool will open a window playing back the input video and indicate with a red or green border if a new intrinsic constraint has been collected (i.e. AprilTag target or checkerboard has been found).</p>
<dl class="section note"><dt>Note</dt><dd>A checkerboard target should be used to capture intrinsics constraints, for better precision compared to AprilTag targets.</dd></dl>
<div class="image">
<img src="intrinsic_constraints.png" alt=""/>
<div class="caption">
Intrinsics Constraints Output</div></div>
    <dl class="section note"><dt>Note</dt><dd>It is important that the tool is able to find at least 30 constraints (checkerboards or AprilTags) per camera.</dd></dl>
<h2><a class="anchor" id="dwx_camera_calibration_tools_ext"></a>
4.3 Camera Calibration</h2>
<p >This section requires the usage of the DriveWorks <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a>, to construct a graph-based representation of the data obtained, which is then further optimized.</p>
<p >Running this tool without parameters assumes you have the file structure specified in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_dir">4.1 Directory Structure</a>.<br  />
 The tool determines the names of the cameras from the <code>extrinsics</code> folder. It then searches the <code>intrinsic</code> folder for <code>.json</code> files corresponding with the intrinsics constraints.<br  />
 The images captured with the external camera will also be used for intrinsic calibration for the external camera, and for extrinsics constraints.<br  />
</p>
<p >The Calibration Tool will then use these images to construct a graph representation which is later optimized.</p>
<h3><a class="anchor" id="dwx_camera_calibration_tools_ext_setup"></a>
4.3.1 Extrinsic Calibration Setup</h3>
<p >Ensure the following before proceeding:</p>
<ul>
<li>The images captured in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data_ext">3.2 Capturing Data for Extrinsic Camera Calibration</a> are in the <code>\&lt;calib_data_path\&gt;/extrinsics</code> directory.</li>
<li>The intrinsics constraints from <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_int">4.2 Camera Intrinsics</a> are in the <code>\&lt;calib_data_path\&gt;/intrinsics</code> directory.</li>
<li>The image file names in <code>extrinsics</code> and the <code>.json</code> file names in <code>intrinsics</code> match.</li>
<li>There is an <code>external.json</code> file with the intrinsics constraints of the external camera in the <code>intrinsics</code> directory.</li>
<li>The images captured by the external camera are placed in the <code>\&lt;calib_data_path\&gt;/external</code> directory.</li>
<li>The <code>targets.json</code> contains the correct barLengths for all AprilTags in the images.</li>
<li>The <code>special-targets.json</code> contains the correct IDs for ground and wheel targets.</li>
<li>If additional constraints are used within a <code>extra-constraints.json</code> file, ensure that <em>all</em> values related to prior knowledge are accurate and consistent with the sensors being calibrated.</li>
</ul>
<h3><a class="anchor" id="dwx_camera_calibration_tools_ext_exec"></a>
4.3.2 Extrinsic Calibration Execution</h3>
<p >Run the <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a> by executing the following: </p><pre class="fragment">./calibration-graph-cli --dir=&lt;calib_data_path&gt;
</pre><p> The tool outputs progress to the console. Take note of warnings in yellow and errors in red as they indicate possible problems with the calibration.</p>
<p >The following outputs are placed in the target folder:</p>
<ul>
<li><code>calibrated-graph.json</code> is the main output for this tool. This contains all constraints, the calibrated camera models, the camera poses, the target poses, etc.<br  />
 This is an intermediate format which is meant for machine consumption only.</li>
<li>An intrinsics validation image for each camera. See <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_outputs">Calibration Calibration Graph Tool Output</a>.</li>
<li>An extrinsics validation image for each camera and for each external image. See <a class="el" href="dwx_calibration_graph_cli.html#dwx_graph_cli_outputs">Calibration Calibration Graph Tool Output</a>.</li>
</ul>
<h3><a class="anchor" id="dwx_camera_calibration_tools_ext_val"></a>
4.3.3 Extrinsic Calibration Validation</h3>
<p >Validation images can be used to double check if the computed calibration is valid, i.e., if the green re-projections match the targets.</p>
<p >In the following image, a green mask clearly overlays the AprilTag targets, and the corners are well aligned. This indicates a valid computed calibration.</p>
<div class="image">
<img src="validation_good.png" alt=""/>
<div class="caption">
Valid Calibration</div></div>
    <p >In the following image, a green mask is misaligned with the AprilTag target. This indicates the calibration results might not be correct, or that there is a problem with the calibration target.</p>
<div class="image">
<img src="validation_bad.png" alt=""/>
<div class="caption">
Invalid Calibration</div></div>
    <dl class="section note"><dt>Note</dt><dd>In most cases an invalid re-projection of the calibration mask occurs when:<ul>
<li>Bad intrinsic calibration:<ul>
<li>The set of intrinsics constraints extracted from the intrinsics calibration recording does not adequately cover the camera's field. Double check that intrinsic validation images contain points that are uniformly distributed over the whole image, and the reprojection error of each point should be small.</li>
</ul>
</li>
<li>Target corner detection in extrinsics images failed or is not precise.<ul>
<li>This may occur if the image is blurry, low quality or the target is too small in the image.</li>
</ul>
</li>
<li>Targets are not flat. Ensure that all targets are flat, rigid, and do not bend.</li>
<li>The bar length of an AprilTag target in <code>targets.json</code> is not correct.</li>
<li>The IDs in the <code>special-targets.json</code> are not correct. In particular this can cause the coordinate system to be wrong.</li>
<li>Prior knowledge provided with <code>extrinsic-constraints.json</code> does not correspond to the actual true values. This can causes the estimation to be restricted to an incorrect space of solutions.</li>
</ul>
</dd></dl>
<p>Ensure that the coordinate system is as expected. An orange line should be where the rear wheels touch the floor. The other orange line should go through the projection of the rear axle center onto the ground, and go along the forward direction of the car. If this is not the case, double check that the wheel and ground targets in the <code>special-targets.json</code> are correct.</p>
<p ><img src="calibration_validation_coordsystem.jpg" alt="Correct Coordinate System" class="inline"/></p>
<h2><a class="anchor" id="dwx_camera_calibration_tools_rig"></a>
4.4 Generating DriveWorks &lt;tt&gt;rig.json&lt;/tt&gt; File</h2>
<p >The <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a> generates a <code>calibrated-graph.json</code> file as output. This file contains an intermediate calibration result, it cannot yet be consumed by the NVIDIA<sup>&reg;</sup> DriveWorks SDK. The calibrated graph can be converted into a valid DriveWorks SDK <code>rig.json</code> file using the <a class="el" href="dwx_calibration_graph_to_rig.html">Calibrated Graph to Rig File Tool</a>. The <code>rig.json</code> file contains the full calibrated camera configuration and can be directly consumed by the DriveWorks modules, e.g. <a class="el" href="rig_mainsection.html">Rig Configuration</a>.</p>
<p >To perform the conversion, run the tool by executing the following: </p><pre class="fragment">./calibration-graph-to-rig --graph=&lt;calib_data_path&gt;/calibrated-graph.json
</pre><p> The tool generates a <code>rig.json</code> file in the current folder. This file lists all cameras used during calibration with their final intrinsic and extrinsic calibration data.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;rig&quot;: {</div>
<div class="line">        &quot;sensors&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;name&quot;: &quot;CameraA&quot;,</div>
<div class="line">                &quot;protocol&quot;: &quot;camera&quot;,</div>
<div class="line">                &quot;parameter&quot;: &quot;&quot;,</div>
<div class="line">                &quot;properties&quot;: {</div>
<div class="line">                    &quot;Model&quot;: &quot;pinhole&quot;,</div>
<div class="line">                    &quot;cx&quot;: &quot;960.00000&quot;,</div>
<div class="line">                    &quot;cy&quot;: &quot;604.00000&quot;,</div>
<div class="line">                    &quot;distortion&quot;: &quot;-3.38998615741730e-1 2.48174026608467e-1 0.000000000000000 &quot;,</div>
<div class="line">                    &quot;fx&quot;: &quot;1829.0598&quot;,</div>
<div class="line">                    &quot;fy&quot;: &quot;1150.4340&quot;,</div>
<div class="line">                    &quot;height&quot;: &quot;1208&quot;,</div>
<div class="line">                    &quot;width&quot;: &quot;1920&quot;</div>
<div class="line">                },</div>
<div class="line">                &quot;correction_rig_T&quot;: [</div>
<div class="line">                    0.0,</div>
<div class="line">                    0.0,</div>
<div class="line">                    0.0</div>
<div class="line">                ],</div>
<div class="line">                &quot;correction_sensor_R_FLU&quot;: {</div>
<div class="line">                    &quot;roll-pitch-yaw&quot;: [</div>
<div class="line">                        -2.9311993804404e-11,</div>
<div class="line">                        1.66752689434446e-09,</div>
<div class="line">                        -6.67010668919943e-09</div>
<div class="line">                    ]</div>
<div class="line">                },</div>
<div class="line">                &quot;nominalSensor2Rig_FLU&quot;: {</div>
<div class="line">                    &quot;roll-pitch-yaw&quot;: [</div>
<div class="line">                        0.00125622225459665,</div>
<div class="line">                        -0.0149850230664015,</div>
<div class="line">                        0.0607732236385345</div>
<div class="line">                    ],</div>
<div class="line">                    &quot;t&quot;: [</div>
<div class="line">                        1.5044356584549,</div>
<div class="line">                        -0.00227832840755582,</div>
<div class="line">                        1.49242639541626</div>
<div class="line">                    ]</div>
<div class="line">                }</div>
<div class="line">            },</div>
<div class="line">            ...</div>
<div class="line">            ],</div>
<div class="line">        &quot;vehicle&quot;: {</div>
<div class="line">            &quot;valid&quot;: false,</div>
<div class="line">            &quot;value&quot;: {</div>
<div class="line">                &quot;axlebaseFront&quot;: 0.0,</div>
<div class="line">                &quot;axlebaseRear&quot;: 0.0,</div>
<div class="line">                &quot;bumperFront&quot;: 0.0,</div>
<div class="line">                &quot;bumperRear&quot;: 0.0,</div>
<div class="line">                &quot;centerOfMassToRearAxle&quot;: 0.0,</div>
<div class="line">                &quot;driveByWireTimeConstant&quot;: 0.0,</div>
<div class="line">                &quot;driveByWireTimeDelay&quot;: 0.0,</div>
<div class="line">                &quot;frontCorneringStiffness&quot;: 0.0,</div>
<div class="line">                &quot;height&quot;: 0.0,</div>
<div class="line">                &quot;inertia&quot;: 0.0,</div>
<div class="line">                &quot;length&quot;: 0.0,</div>
<div class="line">                &quot;mass&quot;: 0.0,</div>
<div class="line">                &quot;rearCorneringStiffness&quot;: 0.0,</div>
<div class="line">                &quot;steeringCoefficient&quot;: 0.0,</div>
<div class="line">                &quot;wheelDiameter&quot;: 0.0,</div>
<div class="line">                &quot;wheelbase&quot;: 0.0,</div>
<div class="line">                &quot;width&quot;: 0.0,</div>
<div class="line">                &quot;widthWithMirrors&quot;: 0.0</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    },</div>
<div class="line">    &quot;version&quot;: 2</div>
<div class="line">}</div>
</div><!-- fragment --><p >If an existing <code>rig.json</code> is passed as input, all camera entries are modified with the new calibration results.</p>
<dl class="section note"><dt>Note</dt><dd>The coordinate system conventions used by the calibration tools can be found in <a class="el" href="dwx_coordinate_systems.html">Coordinate Systems</a>.</dd></dl>
<h1><a class="anchor" id="dwx_camera_calibration_additional_info"></a>
5 Additional Information</h1>
<h2><a class="anchor" id="dwx_camera_calibration_int_only"></a>
5.1 Intrinsic-only Calibration</h2>
<p >It is possible to calibrate for camera intrinsics only, if extrinsic calibration is not desired or required.</p>
<p >The procedure is similar to the full calibration workflow, with minor modifications:</p>
<ol type="1">
<li>Record intrinsics constraints as described in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data_int">3.1 Capturing Data for Intrinsic Camera Calibration</a> with the checkerboard or AprilTag patterns described in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_data_int">3.1 Capturing Data for Intrinsic Camera Calibration</a>.</li>
<li>Create the directory structure as described in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_dir">4.1 Directory Structure</a><ul>
<li>difference: only the <code>intrinsics</code> directory and the <code>targets.json</code> file are required.</li>
</ul>
</li>
<li>Execute the <a class="el" href="dwx_calibration_graph_cli.html">Graph Calibration Tool</a> as demonstrated in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_ext_exec">4.3.2 Extrinsic Calibration Execution</a>.<ul>
<li>This generates a <code>calibrated-graph.json file</code> and intrinsic validation images. Verify that these validation images meet the requirements described in <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_ext_val">4.3.3 Extrinsic Calibration Validation</a>.</li>
</ul>
</li>
<li>Execute the <a class="el" href="dwx_calibration_graph_to_rig.html">Calibrated Graph to Rig File Tool</a> to populate a <code>rig.json</code> file with the result. Refer to <a class="el" href="dwx_camera_calibration.html#dwx_camera_calibration_tools_rig">4.4 Generating DriveWorks <code>rig.json</code> File</a> for more information. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->

  <div id="nav-path" class="navpath">
    <ul>
      <li class="footer">
        Advance Information | Subject to Change |
        Prepared and Provided under NDA | Generated by NVIDIA |
        PR-08397-V5.0
      </li>
     </ul>
  </div>
</body>
</html>
