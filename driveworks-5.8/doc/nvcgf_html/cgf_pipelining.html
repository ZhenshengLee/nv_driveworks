<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!--
 * Copyright (c) 2022 NVIDIA CORPORATION.  All rights reserved.
 *
 * NVIDIA Corporation and its licensors retain all intellectual property
 * and proprietary rights in and to this software, related documentation
 * and any modifications thereto.  Any use, reproduction, disclosure or
 * distribution of this software and related documentation without an express
 * license agreement from NVIDIA Corporation is strictly prohibited.
-->
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Compute Graph Framework SDK Reference: Pipelining</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="Nvidia.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="nv.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 110px;">
  <td id="projectlogo" width="19%">
    <a id="nv-logo" href="https://www.nvidia.com/"></a>
  </td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Compute Graph Framework SDK Reference
   &#160;<span id="projectnumber">5.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('cgf_pipelining.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Pipelining </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md36">Phases</a></li>
<li class="level2"><a href="#autotoc_md37">Implementation</a><ul><li class="level3"><a href="#autotoc_md38">Break Data Dependencies across Phases</a></li>
<li class="level3"><a href="#autotoc_md39">Change Port Behavior</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md40">Performance</a><ul><li class="level3"><a href="#autotoc_md41">Optimal Scenario</a></li>
<li class="level3"><a href="#autotoc_md42">Realistic Scenario</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md43">References</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p >Commonly a data pipeline is processed in a single iteration of the schedule. Depending on the data dependencies and used hardware engines that can leave the overall utilization very low - especially when the beginning of the data pipeline uses different hardware engines than the end. Consider the following minimal example - for simplicity the passes are folded into the nodes:</p>
<p ><div class="dotgraph">
<img src="dot_pipelining_dag.png" alt="dot_pipelining_dag.png" border="0" usemap="#dot_pipelining_dag.map"/>
<div class="caption">
DAG with Asymmetric Hardware Engine Usage</div>
</div>
</p>
<p >Without pipelining the schedule would look like this:</p>
<div class="plantumlgraph">
<img src="pipelining_optimal_without.png" />
<div class="caption">
Schedule without Pipelining</div>
</div>
<h2><a class="anchor" id="autotoc_md36"></a>
Phases</h2>
<p >Pipelining splits a data pipeline into multiple <b>phases</b>. The number of phases is the <b>pipelining depth</b>.</p>
<blockquote class="doxtable">
<p >&zwj;Note: Currently only a maximum pipelining depth of 2 is supported. </p>
</blockquote>
<p>The phases of the <b>Nth iteration of the data pipeline</b> are spread over N iterations of the schedule.</p>
<ul>
<li>the Nth iteration of the first phase of the data pipeline is run in the Nth iteration of the schedule whereas</li>
<li>the Nth iteration of the second phase of the data pipeline is run in the (N+1)th iteration of the schedule.</li>
</ul>
<p >This allows scheduling phases of the data pipeline concurrently within the same scheduling iteration where the data dependencies would otherwise enforce them to run sequentially.</p>
<blockquote class="doxtable">
<p >&zwj;Note: for phase-1 nodes the <b>data pipeline iteration counter</b> equals the <b>schedule iteration counter</b>. </p>
</blockquote>
<p>In the <b>Nth iteration of the schedule</b> the following phases are run in parallel:</p>
<ul>
<li>the 1st phase of the Nth iteration of the data pipeline as well as</li>
<li>the 2nd phase of the (N-1)th iteration of the data pipeline.</li>
</ul>
<blockquote class="doxtable">
<p >&zwj;Note: on the first schedule iteration the second phase doesn't have input data yet and needs to become a no-op. </p>
</blockquote>
<div class="plantumlgraph">
<img src="pipelining_phases.png" />
<div class="caption">
Phases split across Schedule Iterations</div>
</div>
<h2><a class="anchor" id="autotoc_md37"></a>
Implementation</h2>
<p >The implementation of splitting the schedule into two phases is done <em>without</em> STM having any special knowledge about it. When generating the input for the STM compiler, the DAG within an epoch is <em>split into disconnected subgraphs</em>. A former fully connected graph is split into N <em>connected components</em> - where N is the pipelining depth.</p>
<h3><a class="anchor" id="autotoc_md38"></a>
Break Data Dependencies across Phases</h3>
<p >This "disconnection" is achieved by breaking data dependencies commonly derived from the connections in the DAG if the connections spans across phases - the source being a node in phase 1 and the destination being a node in phase 2. This allows the phase-2 nodes to be scheduled concurrently with the phase-1 nodes within the same scheduling iteration. (The case where the source being in phase 2 and the destination being in phase 1 implies an indirect connection which doesn't result in a data dependency anyway.)</p>
<h3><a class="anchor" id="autotoc_md39"></a>
Change Port Behavior</h3>
<p >Additionally, the behavior of a subset of the ports is modified.</p>
<ul>
<li>Ports which are the source of a connection spanning across phases annotate each sent message with their <b>data pipeline iteration counter</b>. With only two phases being supported the source port must be phase-1 node and therefore the annotated counter is also the <b>schedule iteration counter</b>.</li>
<li>Ports which are the destination of a connection spanning across phases are annotated with the <b>offset</b> of their phase to the first phase of the pipeline (for phase-2 ports the offset is 1). This enables consumer ports to determine their <b>data pipeline iteration counter</b> (which is their <b>schedule iteration counter</b> minus their <b>offset</b>). Only when the annotated <b>data pipeline iteration counter</b> of the message is smaller or equal than the <b>data pipeline iteration counter</b> of the destination port the data is being made available to the node in that iteration. This prevents reading messages "from the future" - from phase-1 nodes in schedule iteration N which belong to the data pipeline iteration N where the phase-2 nodes are still processing data pipeline iteration N-1.</li>
<li>Ports of connections which share the source port with connections spanning across phases must be updated to match the fact that the source attaches the iteration counter (and therefore changes the wire format of the data).</li>
</ul>
<h2><a class="anchor" id="autotoc_md40"></a>
Performance</h2>
<h3><a class="anchor" id="autotoc_md41"></a>
Optimal Scenario</h3>
<p >In the optimal case the schedule iteration duration is reduced by half which implies that the rate the data pipeline is running at is doubled. As a consequence the hardware engine utilization is doubled too. The overall runtime of the data pipeline stays the same though - since it is just split evenly across two phases / schedule iterations.</p>
<div class="plantumlgraph">
<img src="pipelining_optimal_with.png" />
<div class="caption">
Schedule with Pipelining - Optimal Result</div>
</div>
<h3><a class="anchor" id="autotoc_md42"></a>
Realistic Scenario</h3>
<p >Realistically splitting the passes across two phases results in the schedule iteration duration to be longer than 50% of the original length. This still means that the rate the data pipeline is running at is increased. But as a consequence the overall runtime of the data pipeline might increase too.</p>
<div class="plantumlgraph">
<img src="pipelining_realistic_without.png" />
<div class="caption">
Schedule without Pipelining</div>
</div>
<div class="plantumlgraph">
<img src="pipelining_realistic_with.png" />
<div class="caption">
Schedule with Pipelining - Realistic Result</div>
</div>
<h2><a class="anchor" id="autotoc_md43"></a>
References</h2>
<p >The schema for <a class="el" href="app_8schema_8json.html">.app.json</a> files captures the assignment of components in the schedule to phases under <code>stmSchedules</code> -&gt; <code>&lt;hyperepoch&gt;</code> -&gt; <code>&lt;epoch&gt;</code> -&gt; <code>passes</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
